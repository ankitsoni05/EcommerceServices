# Clean Architecture - Visual Diagrams & Flow Charts

## Table of Contents
1. [Layer Structure](#layer-structure)
2. [Dependency Flow](#dependency-flow)
3. [Request Flow](#request-flow)
4. [Project Structure](#project-structure)
5. [Comparison Diagrams](#comparison-diagrams)

---

## Layer Structure

### Onion Architecture View

```
                    ???????????????????????????????????????
                    ?                                     ?
                    ?    PRESENTATION LAYER               ?
                    ?    (Controllers, Middleware)        ?
                    ?    • CatalogController              ?
                    ?    • Error Handling                 ?
                    ?                                     ?
                    ???????????????????????????????????????
                                   ?
                    ???????????????????????????????????????
                    ?                                     ?
                    ?    APPLICATION LAYER                ?
                    ?    (Business Workflows)             ?
                    ?    • CatalogService                 ?
                    ?    • DTOs                           ?
                    ?    • Use Cases                      ?
                    ?                                     ?
                    ???????????????????????????????????????
                                   ?
          ???????????????????????????????????????????????????
          ?                        ?                        ?
????????????????????????  ????????????????????  ?????????????????????
?                      ?  ?                  ?  ?                   ?
?  INFRASTRUCTURE      ?  ?  DOMAIN LAYER    ?  ?  INFRASTRUCTURE   ?
?  (Data Access)       ?  ?  (Core)          ?  ?  (External APIs)  ?
?                      ?  ?                  ?  ?                   ?
? • Repositories       ?  ? • Entities       ?  ? • Email Service   ?
? • DbContext          ?  ? • Interfaces     ?  ? • File Storage    ?
? • Migrations         ?  ? • Business Rules ?  ? • Cache           ?
?                      ?  ?                  ?  ?                   ?
????????????????????????  ????????????????????  ?????????????????????
         ?                         ?                       ?
         ???????????????????????????????????????????????????
                                   ?
                          ???????????????????
                          ?                 ?
                          ?   DATABASE      ?
                          ?   EXTERNAL      ?
                          ?   SERVICES      ?
                          ?                 ?
                          ???????????????????
```

### Simple Layer View

```
????????????????????????????????????????????????????????????
?                    PRESENTATION                          ?
?  Controllers, API Endpoints, UI                          ?
?  Files: CatalogController.cs                             ?
????????????????????????????????????????????????????????????
                          ? depends on
????????????????????????????????????????????????????????????
?                    APPLICATION                           ?
?  Business Logic, Use Cases, DTOs                         ?
?  Files: CatalogService.cs, DTOs                          ?
????????????????????????????????????????????????????????????
                          ? depends on
????????????????????????????????????????????????????????????
?                    DOMAIN (CORE)                         ?
?  Entities, Business Rules, Interfaces                    ?
?  Files: CatalogItem.cs, ICatalogRepository.cs            ?
????????????????????????????????????????????????????????????
                          ? implements
????????????????????????????????????????????????????????????
?                    INFRASTRUCTURE                        ?
?  Database, External Services, File System                ?
?  Files: InMemoryCatalogRepository.cs                     ?
????????????????????????????????????????????????????????????
```

---

## Dependency Flow

### Correct Dependencies (Inward)

```
        ???????????????????
        ?  Presentation   ?
        ?   (Controllers) ?
        ???????????????????
                 ?
                 ? (depends on)
        ??????????????????
        ?  Application   ?
        ?   (Services)   ?
        ??????????????????
                 ?
                 ? (depends on)
        ??????????????????
        ?    Domain      ????????
        ?  (Entities)    ?      ?
        ??????????????????      ?
                                ? (implements)
                       ???????????????????
                       ? Infrastructure  ?
                       ? (Repositories)  ?
                       ???????????????????
```

### Key Principle

```
? CORRECT: Outer ? Inner
???????????????????????????
Controllers    ? Services   ?
Services       ? Domain     ?
Infrastructure ? Domain     ? (implements interfaces)

? WRONG: Inner ? Outer
???????????????????????????
Domain         ? Services   ?
Domain         ? Controllers?
Services       ? Controllers?
```

---

## Request Flow

### HTTP Request to Response

```
1. CLIENT
   ?
   ? HTTP POST /api/catalog
   ? { "name": "iPhone", "price": 999 }
   ?
   ?
2. CONTROLLER (Presentation Layer)
   ?
   ? CatalogController.CreateItem()
   ? • Receives HTTP request
   ? • Validates request format
   ? • Extracts data
   ?
   ?
3. SERVICE (Application Layer)
   ?
   ? CatalogService.CreateItemAsync()
   ? • Business validation
   ? • Maps DTO ? Entity
   ? • Orchestrates workflow
   ?
   ?
4. REPOSITORY INTERFACE (Domain Layer)
   ?
   ? ICatalogRepository.AddItemAsync()
   ? • Contract definition
   ?
   ?
5. REPOSITORY IMPLEMENTATION (Infrastructure Layer)
   ?
   ? InMemoryCatalogRepository.AddItemAsync()
   ? • Saves to storage
   ? • Returns saved entity
   ?
   ?
6. BACK TO SERVICE
   ?
   ? • Maps Entity ? DTO
   ? • Returns DTO
   ?
   ?
7. BACK TO CONTROLLER
   ?
   ? • Creates HTTP response
   ? • Sets status code (201 Created)
   ? • Returns JSON
   ?
   ?
8. RESPONSE TO CLIENT
   HTTP 201 Created
   { "id": 1, "name": "iPhone", "price": 999 }
```

### Detailed Flow with Code

```
???????????????????????????????????????????????????????????
? 1. HTTP Request                                         ?
?    POST /api/catalog                                    ?
?    Body: { "name": "iPhone", "price": 999 }             ?
???????????????????????????????????????????????????????????
                     ?
                     ?
???????????????????????????????????????????????????????????
? 2. CatalogController (Presentation)                     ?
?                                                          ?
?    [HttpPost]                                            ?
?    public async Task<ActionResult> CreateItem(           ?
?        CreateCatalogItemDto dto)                         ?
?    {                                                     ?
?        // Delegates to service ?????                    ?
?    }                                ?                    ?
???????????????????????????????????????????????????????????
                                      ?
                                      ?
???????????????????????????????????????????????????????????
? 3. CatalogService (Application)                         ?
?                                                          ?
?    public async Task<CatalogItemDto>                    ?
?        CreateItemAsync(CreateCatalogItemDto dto)        ?
?    {                                                     ?
?        // 1. Validation                                  ?
?        // 2. DTO ? Entity                               ?
?        var item = new CatalogItem { ... };              ?
?        // 3. Save via repository ???                    ?
?    }                                ?                    ?
???????????????????????????????????????????????????????????
                                      ?
                                      ?
???????????????????????????????????????????????????????????
? 4. ICatalogRepository (Domain Interface)                ?
?                                                          ?
?    public interface ICatalogRepository                  ?
?    {                                                     ?
?        Task<CatalogItem> AddItemAsync(CatalogItem);     ?
?    }                                                     ?
???????????????????????????????????????????????????????????
                                      ?
                                      ?
???????????????????????????????????????????????????????????
? 5. InMemoryCatalogRepository (Infrastructure)           ?
?                                                          ?
?    public Task<CatalogItem> AddItemAsync(               ?
?        CatalogItem item)                                ?
?    {                                                     ?
?        item.Id = _nextId++;                             ?
?        _items.Add(item);                                ?
?        return Task.FromResult(item);                    ?
?    }                                                     ?
???????????????????????????????????????????????????????????
```

---

## Project Structure

### File Organization

```
CatalogService/
?
??? Domain/                          ? CORE (No dependencies)
?   ??? Entities/
?   ?   ??? CatalogItem.cs          ? Business entity
?   ?   ??? CatalogBrand.cs         ? Business entity
?   ?   ??? CatalogType.cs          ? Business entity
?   ?
?   ??? Interfaces/
?       ??? ICatalogRepository.cs    ? Repository contract
?
??? Application/                     ? BUSINESS LOGIC
?   ??? Services/
?   ?   ??? CatalogService.cs       ? Business workflows
?   ?
?   ??? Interfaces/
?   ?   ??? ICatalogService.cs      ? Service contract
?   ?
?   ??? DTOs/
?       ??? CatalogItemDto.cs       ? Response DTO
?       ??? CreateCatalogItemDto.cs ? Request DTO
?
??? Infrastructure/                  ? TECHNICAL DETAILS
?   ??? Repositories/
?       ??? InMemoryCatalogRepository.cs ? Data access
?
??? Controllers/                     ? API ENDPOINTS
?   ??? CatalogController.cs        ? HTTP handlers
?
??? Program.cs                       ? Startup & DI configuration
??? Dockerfile                       ? Container configuration
??? README.md                        ? Documentation
```

### Dependency Map

```
Program.cs
    ?
    ??? Registers: ICatalogRepository ? InMemoryCatalogRepository
    ??? Registers: ICatalogService ? CatalogService

CatalogController.cs
    ?
    ??? Depends on: ICatalogService

CatalogService.cs (Application)
    ?
    ??? Depends on: ICatalogRepository (Domain interface)
                    CatalogItem (Domain entity)

InMemoryCatalogRepository.cs (Infrastructure)
    ?
    ??? Implements: ICatalogRepository (Domain interface)
        Uses: CatalogItem (Domain entity)
```

---

## Comparison Diagrams

### Traditional Layered Architecture vs Clean Architecture

#### Traditional (Tightly Coupled)

```
???????????????????????????????????????
?         Presentation                ?
?         (Controllers)               ?
???????????????????????????????????????
               ? direct dependency
               ?
????????????????????????????????????????
?         Business Logic               ?
?         (Services)                   ?
???????????????????????????????????????
               ? direct dependency
               ?
????????????????????????????????????????
?         Data Access                  ?
?         (SQL, DbContext)             ?
???????????????????????????????????????
               ?
               ?
         [ Database ]

Problems:
? Can't test without database
? Can't swap databases easily
? UI knows about database
? Hard to maintain
```

#### Clean Architecture (Loosely Coupled)

```
???????????????????????????????????????
?         Presentation                ?
?         (Controllers)               ?
???????????????????????????????????????
               ? interface dependency
               ?
????????????????????????????????????????
?         Application                  ?
?         (Services)                   ?
???????????????????????????????????????
               ? interface dependency
               ?
????????????????????????????????????????
?         Domain (Interfaces)          ?
?         (Contracts)                  ?
???????????????????????????????????????
               ? implementation
???????????????????????????????????????
?         Infrastructure               ?
?         (Repositories)               ?
???????????????????????????????????????
               ?
               ?
         [ Database ]

Benefits:
? Easy to test (use mocks)
? Swap databases without changing logic
? UI independent of database
? Easy to maintain
```

### Monolithic vs Clean Architecture Microservices

#### Monolithic Structure

```
??????????????????????????????????????????
?        Single Application              ?
?                                        ?
?  Controllers ? Services ? Database    ?
?                                        ?
?  • Products, Orders, Users all mixed  ?
?  • One big deployment                 ?
?  • Shared database                    ?
??????????????????????????????????????????
```

#### Clean Architecture Microservices

```
????????????????????  ????????????????????  ????????????????????
?  Catalog Service ?  ?  Order Service   ?  ? Customer Service ?
?                  ?  ?                  ?  ?                  ?
?  Clean Arch      ?  ?  Clean Arch      ?  ?  Clean Arch      ?
?  Structure       ?  ?  Structure       ?  ?  Structure       ?
?                  ?  ?                  ?  ?                  ?
?  ?              ?  ?  ?              ?  ?  ?              ?
? [Catalog DB]    ?  ? [Order DB]      ?  ? [Customer DB]   ?
????????????????????  ????????????????????  ????????????????????
         ?                    ?                      ?
         ?????????????????????????????????????????????
                              ?
                    ?????????????????????
                    ?   API Gateway     ?
                    ?????????????????????
```

### Data Flow Comparison

#### Without DTOs (Exposing Entities)

```
Database Entity ?????????????????
                                ?
public class CatalogItem        ?
{                               ?
    public int Id               ?
    public string Name          ?
    public decimal CostPrice    ? ? Sensitive!
    public decimal Margin       ? ? Sensitive!
    public string InternalNote  ? ? Internal!
}                               ?
                                ?
                                ?
                        Sent to Client ?
```

#### With DTOs (Hiding Internals)

```
Database Entity
    ?
public class CatalogItem
{
    public int Id
    public string Name
    public decimal CostPrice    ? Not exposed
    public decimal Margin       ? Not exposed
}
    ? (Map to DTO)
public class CatalogItemDto
{
    public int Id
    public string Name
    public decimal Price        ? Only public price
}
    ?
Sent to Client ?
```

---

## Testing Structure

### Unit Testing with Clean Architecture

```
                    ??????????????????????
                    ?   Controller Test  ?
                    ?   (Integration)    ?
                    ??????????????????????
                              ?
                              ? Mock Service
                    ??????????????????????
                    ?   Service Test     ?
                    ?   (Unit Test)      ?
                    ??????????????????????
                              ?
                              ? Mock Repository
                    ??????????????????????
                    ?  Domain Test       ?
                    ?  (Unit Test)       ?
                    ??????????????????????
```

### Example Test Structure

```csharp
// Unit Test - Service Layer
[Fact]
public async Task CreateItem_ValidData_ReturnsCreatedItem()
{
    // Arrange
    var mockRepo = new Mock<ICatalogRepository>();
    mockRepo.Setup(r => r.AddItemAsync(It.IsAny<CatalogItem>()))
        .ReturnsAsync(new CatalogItem { Id = 1, Name = "Test" });
    
    var service = new CatalogService(mockRepo.Object);
    
    // Act
    var result = await service.CreateItemAsync(new CreateCatalogItemDto
    {
        Name = "Test",
        Price = 100
    });
    
    // Assert
    Assert.Equal(1, result.Id);
    Assert.Equal("Test", result.Name);
}
```

---

## Evolution Timeline

### Phase 1: Simple Start
```
Controller ? Service ? In-Memory Repository
```

### Phase 2: Add Database
```
Controller ? Service ? EF Core Repository ? SQL Database
```

### Phase 3: Add Caching
```
                      ?? Cache (Redis)
                      ?
Controller ? Service ??
                      ?
                      ?? Repository ? Database
```

### Phase 4: Add Message Queue
```
Controller ? Service ? Repository ? Database
                ?
                ?? Message Queue (RabbitMQ/Azure Service Bus)
                        ?
                        ?? Background Worker
```

### Phase 5: Microservices
```
API Gateway
    ?
    ?? Catalog Service  ? Catalog DB
    ?? Order Service    ? Order DB
    ?? Customer Service ? Customer DB
    ?? Payment Service  ? Payment Gateway
```

---

## Summary Diagram

```
?????????????????????????????????????????????????????????????
?               CLEAN ARCHITECTURE PRINCIPLES               ?
?????????????????????????????????????????????????????????????
?                                                           ?
?  1. Dependencies point INWARD                            ?
?     Outer layers ? Inner layers                          ?
?                                                           ?
?  2. Domain is the CENTER                                 ?
?     Most important, most stable                          ?
?                                                           ?
?  3. Use INTERFACES for contracts                         ?
?     Abstractions over implementations                    ?
?                                                           ?
?  4. Keep layers INDEPENDENT                              ?
?     Change one without affecting others                  ?
?                                                           ?
?  5. Business logic ISOLATED                              ?
?     No frameworks, databases, or UI concerns             ?
?                                                           ?
?????????????????????????????????????????????????????????????
```

---

*These diagrams represent the Clean Architecture implementation in the Catalog Service project.*
